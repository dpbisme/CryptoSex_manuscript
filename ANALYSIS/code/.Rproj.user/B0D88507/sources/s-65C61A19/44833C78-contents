---
title: "24v48"
author: "Elizabeth English"
date: "3/24/2019"
output: html_document
---

# R packages
**These are the R/bioconductor packages used for this analysis:**
```{r packages, message=FALSE, warning=FALSE, results='hide'}
library(dplyr)
library(readr)
library(Biostrings)
library(tximport)
library(genefilter)
library(tidyverse) 
library(RColorBrewer) 
library(reshape2) 
library(edgeR) 
library(limma)
library(gplots)
```

**This dynamic html summary report was compiled in Rmarkdown using the following packages:**
```{r packages.continued, results='hide', message=FALSE, warning=FALSE}
library(rmarkdown)
library(knitr) 
```

# Data generation
## read mapping with Kallisto
```{r read mapping, message=FALSE, warning=FALSE, eval=FALSE}

#build an index from the crypto reference transcriptome
kallisto index -i myCryptoIndex Cryptosporidium_parvum_iowa_ii.ASM16534v1.cdna.all.fa

# now align to cryptosporidium
kallisto quant -i myCryptoIndex -o crypto_24hr_rep1 -t 4 -b 60 24hr-1-RNeasy_S1_mergedLanes_R1.fastq.gz 24hr-1-RNeasy_S1_mergedLanes_R2.fastq.gz
kallisto quant -i myCryptoIndex -o crypto_24hr_rep2 -t 4 -b 60 24hr-2-RNeasy_S2_mergedLanes_R1.fastq.gz 24hr-2-RNeasy_S2_mergedLanes_R2.fastq.gz
kallisto quant -i myCryptoIndex -o crypto_24hr_rep3 -t 4 -b 60 24hr-3-RNeasy_S3_mergedLanes_R1.fastq.gz 24hr-3-RNeasy_S3_mergedLanes_R2.fastq.gz
kallisto quant -i myCryptoIndex -o crypto_48hr_rep1 -t 4 -b 60 48hr-1-RNeasy_S4_mergedLanes_R1.fastq.gz 48hr-1-RNeasy_S4_mergedLanes_R2.fastq.gz
kallisto quant -i myCryptoIndex -o crypto_48hr_rep2 -t 4 -b 60 48hr-2-RNeasy_S5_mergedLanes_R1.fastq.gz 48hr-2-RNeasy_S5_mergedLanes_R2.fastq.gz
kallisto quant -i myCryptoIndex -o crypto_48hr_rep3 -t 4 -b 60 48hr-3-RNeasy_S6_mergedLanes_R1.fastq.gz 48hr-3-RNeasy_S6_mergedLanes_R2.fastq.gz
kallisto quant -i myCryptoIndex -o crypto_sporo_rep1 -t 4 -b 60 --single -l 250 -s 30 Sporo-mRNA_S4_mergedLanes_R1.fastq.gz
kallisto quant -i myCryptoIndex -o crypto_sporo_rep2 -t 4 -b 60 --single -l 250 -s 30 Sporo-mRNA_S5_mergedLanes_R1.fastq.gz
kallisto quant -i myCryptoIndex -o crypto_sporo_rep3 -t 4 -b 60 --single -l 250 -s 30 Sporo-mRNA_S6_mergedLanes_R1.fastq.gz



```

## annotation with Ensembl
```{r annotation, message=FALSE, warning=FALSE, eval=FALSE}
#for crypto this information comes from a downloaded ena.tsv file because there is no EnsDB or biomaRt
cTx <-read_tsv("Cryptosporidium_parvum_iowa_ii.ASM16534v1.37.ena.tsv")
cTx <-as.data.frame(cTx)
cTx <- dplyr::rename(cTx, target_id = transcript_stable_id)
cTx <- dplyr::rename(cTx, gene_name = gene_stable_id)
cTx <- cTx[,c(4,3)]
head(cTx)
```

## importing data into R
```{r data import, message=FALSE, warning=FALSE, eval=FALSE}
ctargets <-read.table("Crypto_studyDesign.txt", row.names=NULL, header = T, as.is = T)
cfiles <- file.path(ctargets$sample, "abundance.h5")
all(file.exists(cfiles))

cTxi_gene <- tximport(cfiles,
                      type = "kallisto",
                      tx2gene = cTx,
                      txOut = FALSE,
                      countsFromAbundance = "lengthScaledTPM")

save(cTxi_gene, file = "cTxi_gene")
```

# Preprocessing and normalization
## study design
```{r design, message=FALSE, warning=FALSE}
ctargets <-read.table("Crypto_studyDesign.txt", row.names=NULL, header = T, as.is = T)
cgroups <- ctargets$treatment
cgroups <- factor(cgroups)
csampleLabels <-ctargets$sample

```

## raw data
```{r raw, message=FALSE, warning=FALSE}
load("cTxi_gene")
DGElist <- DGEList(cTxi_gene$counts)
# use the 'cpm' function from EdgeR to get counts per million
cpm <- cpm(DGElist) 
log2.cpm <- cpm(DGElist, log=TRUE)
log2.cpm.df <- as_tibble(log2.cpm)
colnames(log2.cpm.df) <- csampleLabels
log2.cpm.df <- melt(log2.cpm.df)
colnames(log2.cpm.df) <- c("sample", "expression")
ggplot(log2.cpm.df, aes(x=sample, y=expression, fill=sample)) +
  geom_violin(trim = TRUE, show.legend = TRUE) +
  stat_summary(fun.y = "median", geom = "point", shape = 95, size = 10, color = "black") +
  theme_bw()


```

## filtered data
```{r filtering, message=FALSE, warning=FALSE}
#first, take a look at how many genes or transcripts have no read counts at all
table(rowSums(DGElist$counts==0)==9)
# now set some cut-off to get rid of genes/transcripts with low counts
#set a cut-off to get rid of genes with low counts
keepers <- rowSums(cpm>1)>=3 #more than 1 count in at least 3 samples
DGElist.filtered <- DGElist[keepers,]
dim(DGElist.filtered)

log2.cpm.filtered <- cpm(DGElist.filtered, log=TRUE)
log2.cpm.filtered.df <- as_tibble(log2.cpm.filtered)
colnames(log2.cpm.filtered.df) <- csampleLabels
log2.cpm.filtered.df <- melt(log2.cpm.filtered.df)
colnames(log2.cpm.filtered.df) <- c("sample", "expression")
ggplot(log2.cpm.filtered.df, aes(x=sample, y=expression, fill=sample)) +
  geom_violin(trim = TRUE, show.legend = TRUE) +
  stat_summary(fun.y = "median", geom = "point", shape = 95, size = 10, color = "black") +
  theme_bw()
```

## normalized data
```{r normalize, message=FALSE, warning=FALSE}
DGElist.filtered.norm <- calcNormFactors(DGElist.filtered, method = "TMM")
# use the 'cpm' function from EdgeR to get counts per million from you 
log2.cpm.filtered.norm <- cpm(DGElist.filtered.norm, log=TRUE)
write.table(log2.cpm.filtered.norm,"norm_filtered.txt", quote = FALSE, sep = "\t")

log2.cpm.filtered.norm.df <- as_tibble(log2.cpm.filtered.norm)
colnames(log2.cpm.filtered.norm.df) <- csampleLabels
log2.cpm.filtered.norm.df <- melt(log2.cpm.filtered.norm.df)
colnames(log2.cpm.filtered.norm.df) <- c("sample", "expression")
ggplot(log2.cpm.filtered.norm.df, aes(x=sample, y=expression, fill=sample)) +
  geom_violin(trim = TRUE, show.legend = TRUE) +
  stat_summary(fun.y = "median", geom = "point", shape = 95, size = 10, color = "black") +
  theme_bw()

```

# Exploratory data analysis
## Principal component analysis (PCA) colored by group
```{r PCA, message=FALSE, warning=FALSE}
pca.res <- prcomp(t(log2.cpm.filtered.norm), scale.=F, retx=T)
pc.var<- pca.res$sdev^2 
pc.per<- round(pc.var/sum(pc.var)*100, 1)
pc.per

pca.res.df <- as_tibble(pca.res$x)
ggplot(pca.res.df, aes(x=PC1, y=PC2, color=cgroups)) +
  geom_point(size=5) +
  theme(legend.position="right") 

```


# Differential gene analysis
## set up model matrix
```{r model, message=FALSE, warning=FALSE}
targets <- read.table("Crypto_studyDesign.txt", row.names=NULL, header = T, as.is = T)
treatment <-targets$treatment
treatment <-factor(treatment)
design <- model.matrix(~treatment)
design <- model.matrix(~0 + treatment)
colnames(design) <- levels(treatment)
```

## mean-variance and linear model
```{r linear model, message=FALSE, warning=FALSE}
v.DEGList.filtered.norm <- voom(DGElist.filtered.norm, design, plot = TRUE)

# fit a linear model to your data
```

## set up contrasts
```{r contrasts, message=FALSE, warning=FALSE}
fit <- lmFit(v.DEGList.filtered.norm, design)

contrast.matrix <- makeContrasts(sexualDev = c48hr - c24hr,
                                 asexualGrow = c24hr - sporo,
                                 levels=design)

```

## Bayesan stats
```{r Bayes, message=FALSE, warning=FALSE}
fits <- contrasts.fit(fit, contrast.matrix)
#get bayesian stats for your linear model fit
ebFit <- eBayes(fits)
#stats <- write.fit(ebFit)
```

## Volcano plot - sexual development
```{r volcano1, message=FALSE, warning=FALSE}
myTopHits1 <- topTable(ebFit, adjust ="BH", coef=1, number=4000, sort.by="logFC")
#first, move rownames into the dataframe
myTopHits1 <- rownames_to_column(myTopHits1, "geneID")


ggplot(myTopHits1, aes(y=-log10(adj.P.Val), x=logFC)) + geom_point(size=2) +
  theme_linedraw() +
  theme(axis.title = element_text(size = 19), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), legend.text = element_text(size = 15),
        axis.text.x = element_text(size=14, colour = "black"),
        axis.text.y = element_text(size=14, colour = "black"),
        plot.title = element_text(size=20, colour = "black")) +
  ylim(-0.5,15) +
  xlim(-15,15) +
  geom_hline(yintercept = -log10(0.01), linetype="dashed", colour="grey", size=1) +
  geom_vline(xintercept = 1, linetype="dashed", colour="grey", size=1) +
  geom_vline(xintercept = -1, linetype="dashed", colour="grey", size=1) + 
  ggtitle("24hpi vs 48hpi")
```

## Volcano plot - sexual development with highlighted genes of interest
```{r volcanocolored1, message=FALSE, warning=FALSE}
#Add grouped geneIDs to highlight specific genes on volcano plot
#oocyt wall proteins, potential oocyst wall proteins, tagged female genes from candidates
owp1 <- subset(myTopHits1, geneID== "cgd6_2090" | geneID== "cgd6_200" | geneID== "cgd4_3090" | 
                 geneID== "cgd7_5150" | geneID== "cgd4_670" | geneID== "cgd7_1800" |
                 geneID== "cgd8_3350" | geneID== "cgd4_500" | geneID== "cgd6_210")

powp1 <- subset(myTopHits1, geneID =="cgd2_490" | geneID == "cgd2_850" | geneID == "cgd3_1540" |
                  geneID == "cgd2_2510" | geneID == "cgd8_2670")

Ftagged1 <- subset(myTopHits1, geneID== "cgd7_4810" | geneID== "cgd7_5140")

#AP2 genes
AP2 <- subset(myTopHits1, geneID=="cgd4_1110" | geneID=="cgd8_3130" | geneID=="cgd8_3230" |
                geneID=="cgd1_3520" | geneID=="cgd2_3490" | geneID=="cgd4_3820" |
                geneID=="cgd4_600" | geneID=="cgd5_2570" |  geneID=="cgd5_4250" | 
                geneID=="cgd8_810" | geneID=="cgd4_2950" | geneID=="cgd6_2600" | 
                geneID=="cgd6_2670" | geneID=="cgd3_1980" | geneID=="cgd3_2970" | 
                geneID=="cgd6_1140" | geneID=="cgd6_5320" )

#cyclins and cyclin dependant kinases
cyclinsCDKs1 <- subset(myTopHits1, geneID =="cgd2_2290"| geneID =="cgd7_2490"| geneID =="cgd1_2320"|
                         geneID =="cgd1_3150"| geneID =="cgd1_3310"| geneID =="cgd3_4050"|
                         geneID =="cgd4_2070"| geneID =="cgd7_650"| geneID =="cgd7_660"|
                         geneID =="cgd7_1200"| geneID =="cgd7_4610"| geneID =="cgd4_243"|
                         geneID =="cgd8_2510"| geneID =="cgd1_60"| geneID =="cgd3_1510")

ggplot(myTopHits1, aes(y=-log10(adj.P.Val), x=logFC)) + geom_point(size=2) +
  geom_point(mapping =NULL, owp1, size = 2, colour= "red", inherit.aes = TRUE) +
  geom_point(mapping =NULL, Ftagged1, size = 2, colour= "red", inherit.aes = TRUE) +
  geom_point(mapping=NULL, powp1, size = 2, colour= "red", inherit.aes = TRUE) +
  geom_point(mapping=NULL, AP2, size = 2, colour= "blue", inherit.aes = TRUE) +
  geom_point(mapping=NULL, cyclinsCDKs1, size = 2, colour= "yellow", inherit.aes = TRUE) +
  theme_linedraw() +
  theme(axis.title = element_text(size = 19), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), legend.text = element_text(size = 15),
        axis.text.x = element_text(size=14, colour = "black"),
        axis.text.y = element_text(size=14, colour = "black"),
        plot.title = element_text(size=20, colour = "black")) +
  ylim(-0.5,15) +
  xlim(-15,15) +
  geom_hline(yintercept = -log10(0.01), linetype="dashed", colour="grey", size=1) +
  geom_vline(xintercept = 1, linetype="dashed", colour="grey", size=1) +
  geom_vline(xintercept = -1, linetype="dashed", colour="grey", size=1) + 
  ggtitle("24hpi vs 48hpi")
```

## Volcano plot - asexual growth
```{r volcano2, message=FALSE, warning=FALSE}
myTopHits2 <- topTable(ebFit, adjust ="BH", coef=2, number=4000, sort.by="logFC")
#first, move rownames into the dataframe
myTopHits2 <- rownames_to_column(myTopHits2, "geneID")

ggplot(myTopHits2, aes(y=-log10(adj.P.Val), x=logFC)) + geom_point(size=2) +
  theme_linedraw() +
  theme(axis.title = element_text(size = 19), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), legend.text = element_text(size = 15),
        axis.text.x = element_text(size=14, colour = "black"),
        axis.text.y = element_text(size=14, colour = "black"),
        plot.title = element_text(size=20, colour = "black")) +
  ylim(-0.5,15) +
  xlim(-15,15) +
  geom_hline(yintercept = -log10(0.01), linetype="dashed", colour="grey", size=1) +
  geom_vline(xintercept = 1, linetype="dashed", colour="grey", size=1) +
  geom_vline(xintercept = -1, linetype="dashed", colour="grey", size=1) + 
  ggtitle("Sporozoites vs 24hpi")

```

## Volcano plot - asexual growth with highlighted genes of interest
```{r volcanocolored2, message=FALSE, warning=FALSE}
#Add grouped geneIDs to highlight specific genes on volcano plot
#oocyt wall proteins, potential oocyst wall proteins, tagged female genes from candidates
owp2 <- subset(myTopHits2, geneID== "cgd6_2090" | geneID== "cgd6_200" | geneID== "cgd4_3090" | 
                 geneID== "cgd7_5150" | geneID== "cgd4_670" | geneID== "cgd7_1800" |
                 geneID== "cgd8_3350" | geneID== "cgd4_500" | geneID== "cgd6_210")

powp2 <- subset(myTopHits2, geneID =="cgd2_490" | geneID == "cgd2_850" | geneID == "cgd3_1540" |
                  geneID == "cgd2_2510" | geneID == "cgd8_2670")

Ftagged2 <- subset(myTopHits2, geneID== "cgd7_4810" | geneID== "cgd7_5140")

#AP2 genes
AP22 <- subset(myTopHits2, geneID=="cgd4_1110" | geneID=="cgd8_3130" | geneID=="cgd8_3230" |
                geneID=="cgd1_3520" | geneID=="cgd2_3490" | geneID=="cgd4_3820" |
                geneID=="cgd4_600" | geneID=="cgd5_2570" |  geneID=="cgd5_4250" | 
                geneID=="cgd8_810" | geneID=="cgd4_2950" | geneID=="cgd6_2600" | 
                geneID=="cgd6_2670" | geneID=="cgd3_1980" | geneID=="cgd3_2970" | 
                geneID=="cgd6_1140" | geneID=="cgd6_5320" )

#cyclins and cyclin dependant kinases
cyclinsCDKs2 <- subset(myTopHits2, geneID =="cgd2_2290"| geneID =="cgd7_2490"| geneID =="cgd1_2320"|
                         geneID =="cgd1_3150"| geneID =="cgd1_3310"| geneID =="cgd3_4050"|
                         geneID =="cgd4_2070"| geneID =="cgd7_650"| geneID =="cgd7_660"|
                         geneID =="cgd7_1200"| geneID =="cgd7_4610"| geneID =="cgd4_243"|
                         geneID =="cgd8_2510"| geneID =="cgd1_60"| geneID =="cgd3_1510")

ggplot(myTopHits2, aes(y=-log10(adj.P.Val), x=logFC)) + geom_point(size=2) +
  geom_point(mapping =NULL, owp2, size = 2, colour= "red", inherit.aes = TRUE) +
  geom_point(mapping =NULL, Ftagged2, size = 2, colour= "red", inherit.aes = TRUE) +
  geom_point(mapping=NULL, powp2, size = 2, colour= "red", inherit.aes = TRUE) +
  geom_point(mapping=NULL, AP22, size = 2, colour= "blue", inherit.aes = TRUE) +
  geom_point(mapping=NULL, cyclinsCDKs2, size = 2, colour= "yellow", inherit.aes = TRUE) +
  theme_linedraw() +
  theme(axis.title = element_text(size = 19), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), legend.text = element_text(size = 15),
        axis.text.x = element_text(size=14, colour = "black"),
        axis.text.y = element_text(size=14, colour = "black"),
        plot.title = element_text(size=20, colour = "black")) +
  ylim(-0.5,15) +
  xlim(-15,15) +
  geom_hline(yintercept = -log10(0.01), linetype="dashed", colour="grey", size=1) +
  geom_vline(xintercept = 1, linetype="dashed", colour="grey", size=1) +
  geom_vline(xintercept = -1, linetype="dashed", colour="grey", size=1) + 
  ggtitle("Sporozoites vs 24hpi")
```

## Use desideTests to pull out DEG
```{r desidetests, message=FALSE, warning=FALSE}
results <- decideTests(ebFit, method="global", adjust.method="BH", p.value=0.01, lfc=1)
#look at what the results of a desideTests looks like
head(results)
summary(results)
```

## Generate lists of DEG
```{r DEGlists, message=FALSE, warning=FALSE}
#lists will be generated for: 24 vs 48 hours post infection and sporozoites vs 24 hours post infection
colnames(v.DEGList.filtered.norm$E) <- csampleLabels

DiffGenes1 <- v.DEGList.filtered.norm$E[results[,1] !=0,]
DiffGenes2 <- v.DEGList.filtered.norm$E[results[,2] !=0,]
DiffGenes <- v.DEGList.filtered.norm$E[results[,2] !=0 | results[,1] !=0,]

DiffGenes1File <- as_tibble(DiffGenes1, rownames="geneSymbol")
DiffGenes1File <- transform(DiffGenes1File,
                           sporo.AVG = (crypto_sporo_rep1 +crypto_sporo_rep2 + crypto_sporo_rep3)/3,
                           c24hr.AVG = (crypto_24hr_rep1 + crypto_24hr_rep2 + crypto_24hr_rep3)/3,
                           c48hr.AVG = (crypto_48hr_rep1 + crypto_48hr_rep2 + crypto_48hr_rep3)/3)
DiffGenes1File <- transform(DiffGenes1File,
                           LogFC.48VS24 = c48hr.AVG - c24hr.AVG)

DiffGenes1File <- DiffGenes1File %>%
  dplyr::select(geneSymbol, crypto_sporo_rep1, crypto_sporo_rep2, crypto_sporo_rep3, sporo.AVG,
                crypto_24hr_rep1,crypto_24hr_rep2,crypto_24hr_rep3, c24hr.AVG,
                crypto_48hr_rep1,crypto_48hr_rep2,crypto_48hr_rep3, c48hr.AVG,
                LogFC.48VS24)
write.csv(DiffGenes1File, file="DiffGenes1File.csv")

```

## Heatmaping- Based on all contrasts
```{r heatmap1, message=FALSE, warning=FALSE}
myheatcol <-colorRampPalette(colors=c("blue","white", "red"))(100)
clustRows <- hclust(as.dist(1-cor(t(DiffGenes), method="pearson")), method="complete")
clustColumns <- hclust(as.dist(1-cor(DiffGenes, method="spearman")), method="complete")
clust.assign <- cutree(clustRows, k=7)

module.color <- rainbow(length(unique(clust.assign)), start=0.1, end=0.9) 
module.color <- module.color[as.vector(clust.assign)] 

heatmap.2(DiffGenes, 
          Rowv=as.dendrogram(clustRows), 
          Colv=NA,
          RowSideColors=module.color,
          col=myheatcol, scale='row', labRow=NA,
          density.info="none", trace="none",  
          cexRow=1, cexCol=1) 

names(module.color) <- names(clust.assign) 
barplot(rep(10, max(clust.assign)),
        col=unique(module.color[clustRows$labels[clustRows$order]]), 
        horiz=T, names=unique(clust.assign[clustRows$order]))
```

## Heatmaping- Cluster heatmaps
```{r heatmap2, message=FALSE, warning=FALSE}
# Create heatmap for chosen sub-cluster 1----
cluster1 <- 1 #use c function to grab more than one cluster from the heatmap.  e.g., c(1,2)
mycluster1 <- DiffGenes[names(clust.assign[clust.assign%in%cluster1]),] 
hrsub1 <- hclust(as.dist(1-cor(t(mycluster1), method="pearson")), method="complete") 
clusterIDs1 <- data.frame(Labels=rev(hrsub1$labels[hrsub1$order]))
clusterIDs1 <- as.vector(t(clust.assign))


heatmap.2(mycluster1, 
          Rowv=as.dendrogram(hrsub1), 
          Colv = NA,
          col=myheatcol, scale="row", 
          density.info="none", trace="none", margins = c(8,8),
          RowSideColors=module.color[clust.assign%in%cluster1]) 

clusterSymbols1 <- data.frame(Labels=rev(hrsub1$labels[hrsub1$order]))
clusterSymbols1 <- as.vector(t(clusterSymbols1))
clusterData1 <- DiffGenes[clusterSymbols1,]
clusterData1.df <- as_tibble(clusterData1, rownames = "geneSymbol")
write_csv(clusterData1.df,"Cluster1.csv")

# Create heatmap for chosen sub-cluster 2----
cluster2 <- 2 #use c function to grab more than one cluster from the heatmap.  e.g., c(1,2)
mycluster2 <- DiffGenes[names(clust.assign[clust.assign%in%cluster2]),] 
hrsub2 <- hclust(as.dist(1-cor(t(mycluster2), method="pearson")), method="complete") 
clusterIDs2 <- data.frame(Labels=rev(hrsub2$labels[hrsub2$order]))
clusterIDs2 <- as.vector(t(clust.assign))

# Create heatmap for chosen sub-cluster.
heatmap.2(mycluster2, 
          Rowv=as.dendrogram(hrsub2), 
          Colv = NA,
          col=myheatcol, scale="row", 
          density.info="none", trace="none", margins = c(8,8),
          RowSideColors=module.color[clust.assign%in%cluster2]) 

clusterSymbols2 <- data.frame(Labels=rev(hrsub2$labels[hrsub2$order]))
clusterSymbols2 <- as.vector(t(clusterSymbols2))
clusterData2 <- DiffGenes[clusterSymbols2,]
clusterData2.df <- as_tibble(clusterData2, rownames = "geneSymbol")
write_csv(clusterData2.df,"Cluster2.csv")

# Create heatmap for chosen sub-cluster 3----
cluster3 <- 3 #use c function to grab more than one cluster from the heatmap.  e.g., c(1,2)
mycluster3 <- DiffGenes[names(clust.assign[clust.assign%in%cluster3]),] 
hrsub3 <- hclust(as.dist(1-cor(t(mycluster3), method="pearson")), method="complete") 
clusterIDs3 <- data.frame(Labels=rev(hrsub3$labels[hrsub3$order]))
clusterIDs3 <- as.vector(t(clust.assign))

# Create heatmap for chosen sub-cluster.
heatmap.2(mycluster3, 
          Rowv=as.dendrogram(hrsub3), 
          Colv = NA,
          col=myheatcol, scale="row", 
          density.info="none", trace="none", margins = c(8,8),
          RowSideColors=module.color[clust.assign%in%cluster3]) 

clusterSymbols3 <- data.frame(Labels=rev(hrsub3$labels[hrsub3$order]))
clusterSymbols3 <- as.vector(t(clusterSymbols3))
clusterData3 <- DiffGenes[clusterSymbols3,]
clusterData3.df <- as_tibble(clusterData3, rownames = "geneSymbol")
write_csv(clusterData3.df,"Cluster3.csv")

# Create heatmap for chosen sub-cluster 4----

cluster4 <- 4 #use c function to grab more than one cluster from the heatmap.  e.g., c(1,2)
mycluster4 <- DiffGenes[names(clust.assign[clust.assign%in%cluster4]),] 
hrsub4 <- hclust(as.dist(1-cor(t(mycluster4), method="pearson")), method="complete") 
clusterIDs4 <- data.frame(Labels=rev(hrsub4$labels[hrsub4$order]))
clusterIDs4 <- as.vector(t(clust.assign))

# Create heatmap for chosen sub-cluster.
heatmap.2(mycluster4, 
          Rowv=as.dendrogram(hrsub4), 
          Colv = NA,
          col=myheatcol, scale="row", 
          density.info="none", trace="none", margins = c(8,8),
          RowSideColors=module.color[clust.assign%in%cluster4]) 

clusterSymbols4 <- data.frame(Labels=rev(hrsub4$labels[hrsub4$order]))
clusterSymbols4 <- as.vector(t(clusterSymbols4))
clusterData4 <- DiffGenes[clusterSymbols4,]
clusterData4.df <- as_tibble(clusterData4, rownames = "geneSymbol")
write_csv(clusterData4.df,"Cluster4.csv")

# Create heatmap for chosen sub-cluster 5----
cluster5 <- 5 #use c function to grab more than one cluster from the heatmap.  e.g., c(1,2)
mycluster5 <- DiffGenes[names(clust.assign[clust.assign%in%cluster5]),] 
hrsub5 <- hclust(as.dist(1-cor(t(mycluster5), method="pearson")), method="complete") 
clusterIDs5 <- data.frame(Labels=rev(hrsub5$labels[hrsub5$order]))
clusterIDs5 <- as.vector(t(clust.assign))

# Create heatmap for chosen sub-cluster.
heatmap.2(mycluster5, 
          Rowv=as.dendrogram(hrsub5), 
          Colv = NA,
          col=myheatcol, scale="row", 
          density.info="none", trace="none", margins = c(8,8),
          RowSideColors=module.color[clust.assign%in%cluster5]) 

clusterSymbols5 <- data.frame(Labels=rev(hrsub5$labels[hrsub5$order]))
clusterSymbols5 <- as.vector(t(clusterSymbols5))
clusterData5 <- DiffGenes[clusterSymbols5,]
clusterData5.df <- as_tibble(clusterData5, rownames = "geneSymbol")
write_csv(clusterData5.df,"Cluster5.csv")

# Create heatmap for chosen sub-cluster 6----
cluster6 <- 6 #use c function to grab more than one cluster from the heatmap.  e.g., c(1,2)
mycluster6 <- DiffGenes[names(clust.assign[clust.assign%in%cluster6]),] 
hrsub6 <- hclust(as.dist(1-cor(t(mycluster6), method="pearson")), method="complete") 
clusterIDs6 <- data.frame(Labels=rev(hrsub6$labels[hrsub6$order]))
clusterIDs6 <- as.vector(t(clust.assign))

# Create heatmap for chosen sub-cluster.
heatmap.2(mycluster6, 
          Rowv=as.dendrogram(hrsub6), 
          Colv = NA,
          col=myheatcol, scale="row", 
          density.info="none", trace="none", margins = c(8,8),
          RowSideColors=module.color[clust.assign%in%cluster6]) 

clusterSymbols6 <- data.frame(Labels=rev(hrsub6$labels[hrsub6$order]))
clusterSymbols6 <- as.vector(t(clusterSymbols6))
clusterData6 <- DiffGenes[clusterSymbols6,]
clusterData6.df <- as_tibble(clusterData6, rownames = "geneSymbol")
write_csv(clusterData6.df,"Cluster6.csv")

# Create heatmap for chosen sub-cluster 7----
cluster7 <- 7 #use c function to grab more than one cluster from the heatmap.  e.g., c(1,2)
mycluster7 <- DiffGenes[names(clust.assign[clust.assign%in%cluster7]),] 
hrsub7 <- hclust(as.dist(1-cor(t(mycluster7), method="pearson")), method="complete") 
clusterIDs7 <- data.frame(Labels=rev(hrsub7$labels[hrsub7$order]))
clusterIDs7 <- as.vector(t(clust.assign))

# Create heatmap for chosen sub-cluster.
heatmap.2(mycluster7, 
          Rowv=as.dendrogram(hrsub7), 
          Colv = NA,
          col=myheatcol, scale="row", 
          density.info="none", trace="none", margins = c(8,8),
          RowSideColors=module.color[clust.assign%in%cluster7]) 

clusterSymbols7 <- data.frame(Labels=rev(hrsub7$labels[hrsub7$order]))
clusterSymbols7 <- as.vector(t(clusterSymbols7))
clusterData7 <- DiffGenes[clusterSymbols7,]
clusterData7.df <- as_tibble(clusterData7, rownames = "geneSymbol")
write_csv(clusterData7.df,"Cluster7.csv")

```